param (
    [string]$appPoolName,
    [string]$outputXmlPath
)

function ConvertTo-XmlElement($xmlDoc, $parent, $property, $value) {
    $node = $xmlDoc.CreateElement($property)

    if ($value -is [System.Management.Automation.PSCustomObject]) {
        foreach ($childProperty in $value.PSObject.Properties) {
            ConvertTo-XmlElement $xmlDoc $node $childProperty.Name $childProperty.Value
        }
    } elseif ($value -is [System.Array]) {
        foreach ($item in $value) {
            ConvertTo-XmlElement $xmlDoc $node "Item" $item
        }
    } else {
        if ($value -is [int]) {
            $node.InnerText = $value.ToString()
        } else {
            $node.InnerText = $value
        }
    }

    $parent.AppendChild($node)
}

# Create an XML document
$xmlDoc = New-Object System.Xml.XmlDocument

# Create the root element
$rootNode = $xmlDoc.CreateElement("AppPoolSettings")
$xmlDoc.AppendChild($rootNode)

# Get the application pool settings
$appPool = Get-Item "IIS:\AppPools\$appPoolName"
$appPoolSettings = $appPool | Get-ItemProperty

# Create an element for the application pool settings
$appPoolNode = $xmlDoc.CreateElement("AppPool")
$appPoolNode.SetAttribute("Name", $appPoolName)
$rootNode.AppendChild($appPoolNode)

# Add application pool settings to the XML
foreach ($setting in $appPoolSettings.PSObject.Properties) {
    if ($setting.Value -is [System.Management.Automation.PSCustomObject]) {
        $node = $xmlDoc.CreateElement($setting.Name)
        $appPoolNode.AppendChild($node)

        foreach ($childProperty in $setting.Value.PSObject.Properties) {
            ConvertTo-XmlElement $xmlDoc $node $childProperty.Name $childProperty.Value
        }
    } elseif ($setting.Value -is [System.Array]) {
        $arrayNode = $xmlDoc.CreateElement($setting.Name)
        $appPoolNode.AppendChild($arrayNode)

        foreach ($item in $setting.Value) {
            $node = $xmlDoc.CreateElement("Item")
            ConvertTo-XmlElement $xmlDoc $node "Value" $item
            $arrayNode.AppendChild($node)
        }
    } else {
        $node = $xmlDoc.CreateElement($setting.Name)
        $node.SetAttribute("Name", $setting.Name)
        $appPoolNode.AppendChild($node)
        $node.InnerText = $setting.Value
    }
}

# Save the XML to the specified location
$xmlDoc.Save($outputXmlPath)

Write-Host "AppPool settings exported to: $outputXmlPath"
