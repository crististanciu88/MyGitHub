param (
    [string]$PfxCertificatePath,
    [string[]]$Servers
)

# Load PFX certificate
try {
    $newCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
    $newCert.Import($PfxCertificatePath)

    # Extract the technical account name from the new certificate
    $technicalAccountName = ($newCert.Subject -split ', ' | Where-Object { $_ -like "CN=*" }) -replace 'CN=', ''
} catch {
    Write-Host "Failed to load PFX certificate: $_"
    exit
}

foreach ($server in $Servers) {
    try {
        # Establish a remote session to the server
        $session = New-PSSession -ComputerName $server -ErrorAction Stop

        $existingCert = Invoke-Command -Session $session -ScriptBlock {
            # Get the local machine certificate store
            $certStore = [System.Security.Cryptography.X509Certificates.X509Store]::New("My","LocalMachine")
            $certStore.Open("ReadOnly")

            # Find the specific technical account certificate by CN
            $existingCert = $certStore.Certificates | Where-Object { $_.Subject -like "*CN=$($using:technicalAccountName)*" }
            $certStore.Close()

            return $existingCert
        }

        if ($existingCert) {
            if ($newCert.NotAfter -gt $existingCert.NotAfter) {
                Write-Host "Updating certificate on $server, as the new certificate is newer."
                # Replace existing certificate
                Invoke-Command -Session $session -ScriptBlock {
                    param ($pfxPath, $existingCertThumbprint)
                    $certStore = New-Object System.Security.Cryptography.X509Certificates.X509Store("My", "LocalMachine")
                    $certStore.Open("ReadWrite")
                    $existingCert = $certStore.Certificates | Where-Object { $_.Thumbprint -eq $existingCertThumbprint }
                    if ($existingCert) {
                        $certStore.Remove($existingCert)
                    }
                    $newCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
                    $newCert.Import($pfxPath)
                    $certStore.Add($newCert)
                    $certStore.Close()
                } -ArgumentList $PfxCertificatePath, $existingCert.Thumbprint
            } else {
                Write-Host "No change needed for the certificate on $server."
            }
        } else {
            Write-Host "No existing certificate found for CN=$technicalAccountName on $server."
            # If no existing certificate, you may add the new one if needed
            Invoke-Command -Session $session -ScriptBlock {
                param ($pfxPath)
                $certStore = New-Object System.Security.Cryptography.X509Certificates.X509Store("My", "LocalMachine")
                $certStore.Open("ReadWrite")
                $newCert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
                $newCert.Import($pfxPath)
                $certStore.Add($newCert)
                $certStore.Close()
            } -ArgumentList $PfxCertificatePath
        }

        Remove-PSSession -Session $session
    } catch {
        Write-Host "Failed to process $server: $_"
    }
}
