param (
    [string]$pfxCertificatePath,       # Path to the PFX certificate on the remote server
    [string]$technicalAccount           # Subject name to look for in the certificate store
)

# Define your array of servers (update with your server names/addresses)
$servers = @("Server1", "Server2", "Server3")

# Import the PFX Certificate
$pfxPassword = Read-Host "Enter PFX Password" -AsSecureString
$pfxCertificate = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
$pfxCertificate.Import($pfxCertificatePath, $pfxPassword, 'Exportable')

foreach ($server in $servers) {
    # Use Invoke-Command to run the actions on the remote server
    Invoke-Command -ComputerName $server -ScriptBlock {
        param (
            $pfxCertificate,
            $technicalAccount
        )

        # Open the LocalMachine\Root store
        $store = New-Object System.Security.Cryptography.X509Certificates.X509Store("Root", "LocalMachine")
        $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)

        # Check for existing certificate with the specified subject
        $existingCertificate = $store.Certificates | Where-Object { $_.Subject -eq "CN=$technicalAccount" }

        if ($existingCertificate) {
            # Compare the existing certificate and new certificate 'NotAfter' dates
            if ($existingCertificate.NotAfter -lt $pfxCertificate.NotAfter) {
                # Existing certificate expires first, so we need to remove it
                $store.Remove($existingCertificate)
                Write-Host "Removed existing certificate from $($existingCertificate.Subject) on $env:COMPUTERNAME"
                
                # Store the new certificate
                $store.Add($pfxCertificate)
                Write-Host "Added new certificate from $($pfxCertificate.Subject) to $env:COMPUTERNAME"
            } else {
                # New certificate expires first, so we discard it
                Write-Host "Existing certificate is valid longer on $env:COMPUTERNAME. New certificate discarded."
            }
        } else {
            # No existing certificate, add the new certificate
            $store.Add($pfxCertificate)
            Write-Host "No existing certificate found. Added new certificate to $env:COMPUTERNAME"
        }

        # Close the certificate store
        $store.Close()
    } -ArgumentList $pfxCertificate, $technicalAccount
}
