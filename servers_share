# Define the parameters
$ServerList = "C:\Path\To\Your\ServerList.txt" # Path to your text file with server names
$ShareName = "CShare" # Name of the share you want to create
$SharePath = "C:\" # Path to share
$ReadOnlyGroups = @("Domain\\Group1", "Domain\\Group2") # Adjust according to your groups

# Read the server list
$Servers = Get-Content -Path $ServerList

foreach ($Server in $Servers) {
    try {
        # Check if the share already exists
        $existingShare = Get-WmiObject -Class Win32_Share -ComputerName $Server -ErrorAction Stop | Where-Object { $_.Name -eq $ShareName }

        if ($existingShare) {
            Write-Host "$ShareName already exists on $Server. Skipping creation."
        } else {
            # Create the share
            New-SmbShare -Name $ShareName -Path $SharePath -FullAccess "Administrators" -ErrorAction Stop
            Write-Host "Share $ShareName created on $Server."
        }

        # Set read-only permissions
        foreach ($group in $ReadOnlyGroups) {
            # Grant read access to the group
            Grant-SmbShareAccess -Name $ShareName -AccountName $group -AccessRight Read -ErrorAction Stop
            Write-Host "Granted read access for $group on $ShareName on $Server."
        }
    } catch {
        Write-Host "An error occurred on $Server: $_"
    }
}
