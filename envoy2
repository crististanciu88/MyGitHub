apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: lua-xff-filter
  namespace: your-namespace
spec:
  workloadSelector:
    labels:
      app: your-app
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: "envoy.filters.http.lua"
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inline_code: |
            function envoy_on_request(request_handle)
              -- Get the current X-Forwarded-For header
              local xff = request_handle:headers():get("x-forwarded-for")
              -- Get the downstream remote IP
              local downstream_ip = request_handle:downstream_remote_address()
              
              -- Append the downstream IP to the X-Forwarded-For header
              if xff then
                xff = xff .. ", " .. downstream_ip
              else
                xff = downstream_ip
              end

              -- Set the updated X-Forwarded-For header
              request_handle:headers():replace("x-forwarded-for", xff)
            end
