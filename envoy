apiVersion: networking.istio.io/v1beta1
kind: EnvoyFilter
metadata:
  name: internal-gateway-access-log
  namespace: your-namespace
spec:
  workloadSelector:
    labels:
      istio: your-internal-gateway # Replace with the actual labels for your gateway pods
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: GATEWAY
      proxy:
        proxyVersion: ^1.7.0.* # Replace with your Envoy version if necessary
      listener:
        name: internal-gateway-http
        portNumber: 80
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        access_log:
          - name: "envoy.access_loggers.stdout"
            filter:
              filter_expression: "request.headers['x-envoy-internal'] == 'true'"
